<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <title>Align</title>

</head>

<body>
    <div class="container">
        <button class="back-date">Back</button>
        <div id="display-todays-date"></div>
        <button class="forward-date">Forward</button>
    </div>

    <div class="container" id="display-buttons">
        <button type="button" class="btn btn-primary" id="workout" data-toggle="button" aria-pressed="false"
            value="workout">Workout</button>
        <button type="button" class="btn btn-primary" id="skip-musclesoreness" data-toggle="button" aria-pressed="false"
            value="skip-musclesoreness">Skipped: Muscle Soreness</button>
        <button type="button" class="btn btn-primary" id="skip-lazy" data-toggle="button" aria-pressed="false"
            value="skip-lazy">Skipped: Lazy</button>


    </div>

    <div class="container" id="timeOfDay-buttons" style="display: none;">
        <button type="button" class="timeOfDay btn btn-primary" id="morning" data-toggle="button" value="Morning"
            aria-pressed="false">Morning</button>

        <button type="button" class="timeOfDay btn btn-primary" id="afternoon" data-toggle="button" value="Afternoon"
            aria-pressed="false">Afternoon</button>

        <button type="button" class="timeOfDay btn btn-primary" id="evening" data-toggle="button" value="Evening"
            aria-pressed="false">Evening</button>

        <button type="button" class="timeOfDay btn btn-primary" id="late-night" data-toggle="button" value="Late Night"
            aria-pressed="false">Late Night</button>
    </div>

    <div class="container">Today's Running Forecast: <br></br>
        <p>General Forecast:<span class="weather" id="weather-desc"></span></p>
        <p>The temperature outside:<span class="weather" id="temp"></span>&#8451</p>
        <p>Feels like:<span class="weather" id="temp-feels-like"></span>&#8451</p>


    </div>
    <div class="container">
        <form>
            <div class="form-group">
                <label for="weight-input">Enter current weight (lbs)</label>
                <input type="number" class="form-control input-weight" id="input-weight" aria-describedby="enter-weight"
                    placeholder="Enter Weight">
                <button type="submit" class="btn btn-primary submit-button">Submit</button>
        </form>
    </div>

    <!-- Bootstrap link-->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
    <!-- Jquery link-->
    <script src="https://code.jquery.com/jquery.js"></script>

    <!-- Link to javascript file-->
    <script src="assets/grit.js"></script>

    <!--Cloudflare-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js"></script>
    <!-- link to Moments-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-database.js"></script>
    <script>
        //1. Display today's date on the page
        function refreshTime() {
            var todaysDate = moment().format("DD-MMMM-YYYY");
            $("#display-todays-date").html(todaysDate);
        };
        refreshTime();


        // clear out all selections on the buttons 
        function clearSelections() {
            $("#workout").attr("aria-pressed", "false").removeClass("active");
            $("#skip-lazy").attr({ 'aria-pressed': "false" }).removeClass("active");
            $("#skip-musclesoreness").attr("aria-pressed", "false").removeClass("active");
            $("#timeOfDay-buttons").css("display", "none");

        };
        // clear out all stored data in firebase
        function resetData() {
            clickWorkout = false;
            clickMuscleSore = false;
            clickLazy = false;
            clickTimeOfDay = "";

        };

        function resetTimeOfDay() {
            $(".timeOfDay").attr("aria-pressed", "false").removeClass("active");
        };


        var firebaseConfig = {
            apiKey: "AIzaSyA6KPfNXqtMU0Xb8zJxuk7XpOVqZiuaIIE",
            authDomain: "project-align.firebaseapp.com",
            databaseURL: "https://project-align.firebaseio.com",
            projectId: "project-align",
            storageBucket: "project-align.appspot.com",
            messagingSenderId: "992009557306",
            appId: "1:992009557306:web:ece9a9460a4b8f5403ec03"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var storedInFirebase = firebase.database();
        console.log(firebaseConfig);


        // create variables to store the number of instances when a button was clicked
        var clickWorkout = false;
        var clickLazy = false;
        var clickMuscleSore = false;
        var date = $("#display-todays-date").text(); // grab the value of the date from what is populated on the page
        var clickTimeOfDay = "";
        var weight = 0;

        //setInterval(function () { refreshTime() }, 10000);
        // grab the existing data from firebase for a particular date
        function pullFromDb() {
            // check if data exists for the current date
            var checkData = firebase.database().ref(date);

            checkData.on('value', function (snapshot) {
                console.log("blahlal");
                clearSelections();
                resetTimeOfDay();
                console.log(snapshot.val());
                dataReturned = snapshot.val();

                if (dataReturned != null) {
                    console.log("Okay something exists for this date");

                    if (dataReturned.workoutDays === true) {
                        console.log("workout recorded for this date");
                        $("#workout").attr("aria-pressed", "true").addClass("active");
                        $("#timeOfDay-buttons").css("display", "block");

                        if (dataReturned.timeOfDay != null) {
                            if (dataReturned.timeOfDay === "Morning") {
                                console.log("Morning was selected");
                                $("#morning").attr("aria-pressed", "true").addClass("active");

                            }

                            else if (dataReturned.timeOfDay === "Afternoon") {
                                console.log("Afternoon was selected");
                                $("#afternoon").attr("aria-pressed", "true").addClass("active");
                            }

                            else if (dataReturned.timeOfDay === "Evening") {
                                console.log("Evening was selected");
                                $("#evening").attr("aria-pressed", "true").addClass("active");
                            }

                            else {
                                console.log("Late night was selected");
                                $("#late-night").attr("aria-pressed", "true").addClass("active");
                            }

                        }
                        else {
                            console.log("No time of day was selected");
                        }
                    }

                    else if (dataReturned.muscleSoreDays === true) {
                        console.log("muscles sore recorded for this date");
                        $("#skip-musclesoreness").attr("aria-pressed", "true").addClass("active");
                    }

                    else if (dataReturned.lazyDays === true) {
                        console.log("lazy day recorded for this date");
                        $("#skip-lazy").attr({ 'aria-pressed': "true" }).addClass("active");
                    }
                    else {
                        console.log("None clicked");
                    }
                }
                else {
                    console.log("No data stored for this date.");
                }
            });
        };

        pullFromDb();


        // if the user wants, they can toggle  back and forth between dates
        var currentDate = moment();
        $(".back-date").on("click", function () {
            function getBackDate() {
                var backDate = currentDate.subtract(1, 'days').format("DD-MMMM-YYYY");
                console.log("back date: " + backDate);
                $("#display-todays-date").html(backDate);
                date = backDate;
            };
            getBackDate();
            pullFromDb();
            checkWeightEntry();
        });

        $(".forward-date").on("click", function () {
            function getForwardDate() {
                var forwardDate = currentDate.add(1, 'days').format("DD-MMMM-YYYY");
                console.log("forward date: " + forwardDate);
                $("#display-todays-date").html(forwardDate);
                date = forwardDate;
            };
            getForwardDate();
            pullFromDb();
            checkWeightEntry();
        });



        // function to check if weight exists
        // if yes, then store this value in a var and push to db

        function checkWeightEntry() {
            var checkData = firebase.database().ref(date);

            checkData.on('value', function (snapshot) {

                console.log(snapshot.val());
                var dataReturned = snapshot.val();


                console.log(weightReturned);

                try {
                    var weightReturned = parseFloat(dataReturned.weight);
                    if (weightReturned > 0.0) {
                        weight = weightReturned;
                        console.log("weight exists for today already: " + weight);
                        $("#input-weight").val(weight);
                    }
                    else {
                        $("#input-weight").val("");
                    }

                } catch (error) {
                    console.log("No weight key in the db exists");
                    $("#input-weight").val("");
                }


            });
        };
        checkWeightEntry();



        // click event for workout days
        $("#workout").on("click", function () {
            resetData();
            clearSelections();
            checkWeightEntry();
            clickWorkout = true;
            console.log("number of workout clicks: " + clickWorkout);

            $("#timeOfDay-buttons").css("display", "block");


            $(".timeOfDay").on("click", function () {
                resetTimeOfDay();
                clickTimeOfDay = $(this).val();

                console.log("the time of day clickd is: " + clickTimeOfDay);
                console.log("record date value is:" + date);
                firebase.database().ref(date).set({
                    workoutDays: clickWorkout,
                    muscleSoreDays: clickMuscleSore,
                    lazyDays: clickLazy,
                    timeOfDay: clickTimeOfDay,
                    weight: weight

                });
            });
        });
        // click event for muscle sore days
        $("#skip-musclesoreness").on("click", function () {
            resetData();
            clearSelections();
            clickMuscleSore = true;
            console.log("number of muscle sore clicks: " + clickMuscleSore);


            firebase.database().ref(date).set({
                workoutDays: clickWorkout,
                muscleSoreDays: clickMuscleSore,
                lazyDays: clickLazy,
                timeOfDay: clickTimeOfDay,

            });

        });
        // click event for lazy days
        $("#skip-lazy").on("click", function () {
            resetData();
            clearSelections();
            clickLazy = true;
            console.log("number of lazy clicks: " + clickLazy);


            firebase.database().ref(date).set({
                workoutDays: clickWorkout,
                muscleSoreDays: clickMuscleSore,
                lazyDays: clickLazy,
                timeOfDay: clickTimeOfDay,

            });
        });

        function isNumeric(n) {
            return !isNaN(parseFloat(n)) && isFinite(n);
            }
// above isNumeric function taken from https://rosettacode.org/wiki/Determine_if_a_string_is_numeric#JavaScript

        $("#input-weight").keypress(function (){
            var value = $("#input-weight").val().trim();

            if (isNumeric(value)){
                // change the box to blue
                console.log("You're entering a number");
                $("#input-weight").removeClass("is-invalid").removeClass("form-control");
                $("#errordiv").remove();
            }
            else {
                // change the box to red and disable submit button.
                // if a string is being added, remove the is-invalid class and div and re-add
                // so that for each keypress a new div with error message doesn't display.
                console.log("You're entering a string");
                $("#input-weight").removeClass("is-invalid").removeClass("form-control");
                $("#errordiv").remove();
                
                $("#input-weight").addClass("is-invalid").addClass("form-control");
                
                var newDiv = $("<div id='errordiv'>");
                    newDiv.addClass("invalid-feedback");
                    newDiv.append("<p>Please enter a valid number</p>");
                $("#input-weight").parent().append(newDiv);
            }
        });
           

        // when the weight is submitted, update the database with the weight and
        // do not override the existing data for the workout selection
        $(".submit-button").on("click", function () {
            event.preventDefault();
            var weight = $("#input-weight").val().trim();
            var update = { weight: weight };
            console.log("weight is: " + weight);

            firebase.database().ref(date).update(update);

        });




        // weather API

        var cityName = "Toronto";
        var queryURL = "https://api.openweathermap.org/data/2.5/weather?q=" + cityName + "&units=metric&appid=142364713f5047ff8aab04a72c5a2317"

        console.log(queryURL);

        $.ajax({
            url: queryURL,
            method: "GET"
        }).then(function (response) {
            console.log(response);

            var temp = response.main.temp;
            var tempFeelsLike = response.main.feels_like;
            var weatherDesc = response.weather[0].main;

            $("#temp").text(temp);
            $("#temp-feels-like").text(tempFeelsLike);
            $("#weather-desc").text(weatherDesc);


        });
        //3. Create search button to search youtube and populate the first youtube video under 10min.





    </script>
</body>

</html>